<!DOCTYPE html>
<html style="width:100vw; height:100vh;">
<head>
    <title>This place is *groovy*</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="fav1.ico">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0">
    <style type="text/css">
        .scroll::-webkit-scrollbar {
            width: 1vh;
        }
        .scroll::-webkit-scrollbar-track {
            background: #ddd;
        }
        .scroll::-webkit-scrollbar-thumb {
            background: #777; 
        }
        .cam-select-button {
            font-family:'Roboto Mono', monospace;
            padding:1vh;
            font-size:90%;
            font-weight:bold;
            text-transform:capitalize;
            background-color:white;
        }
        .cam-select-button:focus {
            outline: 0;
        }
        .cam-select-button:active {
            border-top: 3px solid rgb(150,150,150);
            border-left: 2.5px solid rgb(150,150,150);
            border-bottom: 1px solid rgb(225,225,225);
            border-right: 1px solid rgb(225,225,225);
            background-color: #e8e8e8;
        }
        .pressed-cam-select-button {
            background-color: #f0f0f0;
            border-top: 2.5px solid rgb(170,170,170);
            border-left: 2.5px solid rgb(170,170,170);
            border-bottom: 2px solid rgb(225,225,225);
            border-right: 2px solid rgb(225,225,225);
        }
        .view {
            margin:0; 
            padding:0; 
            display:none;
        }
        a, a:visited {
            color:black;
            text-decoration:none;
        }
        li {
            margin-top:0.5em;
        }
        .disabled-input {
            background-color:rgb(225,225,225);
            color:rgb(100,100,100);
        }
        .setup-datum {
            margin-top:0.5em;
        }
        .setup-datum-title {
            font-weight: bold;
        }
        .entry-anchor {
            position:relative;
            width:100%;
        }
        .setup-datum-value, .setup-datum-entry {
            text-indent:1em;
            margin-top:0.25em;
            border: 1px solid black;
        }
        .setup-datum-entry {
            background-color:rgb(225,245,255);
            min-width:8em;
            max-width:50vw;
            width:100%;
            position:absolute;
            right:0;
            top:-2em;
            display:flex;
            flex-direction:row;
            justify-content:space-between;
        }
        .setup-entry-cur-val {
            border: 1px solid #474747;
        }
        .setup-entry-cur-val, .plus-minus-button {
            margin:0.25em;
            width:1.5em;
            height:1.5em;
            text-align:center;
            display:flex;
            flex-direction:row;
            justify-content:center;
            align-items:center;
            font-weight:bold;
            text-indent:0;
        }
        .setup-entry-cur-val {
            height:auto;
            width:auto;
            border:none;
        }
        .sub-step-button, .safety-step-button {
            min-height:2.5em;
            margin-top:1em;
            font-weight:bold;
            font-size: 2.5vh;
            font-family:'Roboto Mono', monospace;
        }
        .completed-safety-step {
            flex-direction: row;
            margin-bottom: 0.5em;
        }
        .completed-safety-step div{
            margin-left: 0.5em;
        }
        .completed-safety-step img{
            height: 16px;
            margin-top: 5px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body style="display:flex; flex-direction:row; justify-content:center; align-items:center; width:100vw; height:100vh; margin:0; font-family:'Roboto Mono', monospace; font-size:2.65vh;">

    <div id="main-screen" style="display:flex; flex-direction:row; width:1280px; height:768px; max-width:100vw; max-height:100vh;">
        <div id="left-section" style="width:auto; display:inline-block;">

            <div id="alert-message-board" style="display:fixed; position:absolute; z-index:1000000; width:960px; max-width:75vw; background-color:rgba(0,0,0,.5);">
            </div>

            <div id="video-container" style="width:960px; max-width:75vw; height:691px; max-height:90vh; position:relative; display:flex; flex-direction:row; align-items:center; justify-content:center;">
                <img id="visible-cam-output" src="visible_cam_output.png" alt="visible camera not connected" style="display:none;"/>
                <img id="thermal-cam-output" src="thermal_cam_output.png" alt="thermal camera not connected" style="display:none;">
                <div id="camera-select-bar" style="position:absolute; bottom:2px; left:2px; display:flex; justify-content:center; width:30%; height:auto;">
                    <button id="visible-button" class="tab-select cam-select-button" style="width:50%;">
                    visible
                    </button>
                    <button id="thermal-button" class="tab-select cam-select-button" style="width:50%;">
                    thermal
                    </button>
                </div>    
            </div>
            <div id="status-area-container" style="display:flex; width:100%; height:10vh">
                <div id="status-area" style="display:flex; justify-content:space-around; align-items:center; width:100%; height:10vh; padding-left:1em; padding-right:1em; background-color:black; color:white;">
                </div>
            </div>

            
        </div>
        <div id="right-section" style="width:100%; height:100%; overflow-y:hidden;">
            <div id="right-section-scroll-wrapper" class="scroll" style="width:100%; padding:0; height:580px; max-height:76vh; overflow-y:auto; margin-bottom:0.5em;">
                <div id="right-section-info-div" style="padding-left:1em; padding-right:1em; display:flex; flex-direction:column; justify-content: space-between;">
                    <h1 id="step-title" style="text-decoration:none; font-weight:bold; text-transform:uppercase; font-size:125%; padding-top:0.5em; text-align: center; border-bottom:2px solid black;"></h1>
                    <p id="instruction-text" class="hidden" style="margin-top:0;"></p>
                </div>
                <div id="right-section-views-div" style="padding-left:1em; padding-right:1em; display:flex; flex-direction:column; justify-content: space-between;">

                    <div id="completed-trials-view"  class="view" style="">
                        Trials currently save to&nbsp;<span id="trial-output-path"></span><br/><br/>
                        Open that folder to access results for transfer or email. 
                        <button id="review-trial-button" class="sub-step-button">Browse past trials</button><br/>
                    </div>

                    <div id="trial-setup-view"  class="view">
                        <div id="duration-datum" class="setup-datum">
                            <div class="setup-datum-title">
                                Duration
                            </div>
                            <div class="setup-datum-value" id="setup-duration-display">
                                manual stop
                            </div>
                            <div class="entry-anchor">
                                <div class="setup-datum-entry hidden" id="setup-duration-entry">
                                    <button id="duration-decrement-button" class="plus-minus-button">-</button>
                                    <span id="setup-duration-cur-val" class="setup-entry-cur-val"></span>
                                    <button id="duration-increment-button" class="plus-minus-button">+</button>
                                </div>
                            </div>
                        </div>
                        <div id="power-datum" class="setup-datum">
                            <div class="setup-datum-title">
                                Max Power
                            </div>
                            <div class="setup-datum-value" id="setup-power-display">
                                off
                            </div>
                            <div class="entry-anchor">
                                <div class="setup-datum-entry hidden" id="setup-power-entry">
                                    <button id="power-decrement-button" class="plus-minus-button">-</button>
                                    <span id="setup-power-cur-val" class="setup-entry-cur-val"></span>
                                    <button id="power-increment-button" class="plus-minus-button">+</button>
                                </div>
                            </div>
                        </div>
                        <div id="temperature-datum" class="setup-datum">
                            <div class="setup-datum-title">
                                Target Set Temp Delta
                            </div>
                            <div class="setup-datum-value" id="setup-temperature-display">
                                unheated
                            </div>
                            <div class="entry-anchor">
                                <div class="setup-datum-entry hidden" id="setup-temperature-entry">
                                    <button id="temperature-decrement-button" class="plus-minus-button">-</button>
                                    <span id="setup-temperature-cur-val" class="setup-entry-cur-val"></span>
                                    <button id="temperature-increment-button" class="plus-minus-button">+</button>
                                </div>
                            </div>
                        </div>
                        <div id="ambient-datum" class="setup-datum disabled-datum">
                            <div class="setup-datum-title">
                                Ambient Setting
                            </div>
                            <div class="setup-datum-value disabled-input" id="setup-ambient-display">
                                disabled
                            </div>
                            <div class="entry-anchor">
                                <div class="setup-datum-entry hidden" id="setup-ambient-entry">
                                    <button id="ambient-decrement-button" class="plus-minus-button">-</button>
                                    <span id="setup-ambient-cur-val" class="setup-entry-cur-val"></span>
                                    <button id="ambient-increment-button" class="plus-minus-button">+</button>
                                </div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <button id="load-profile-button" class="sub-step-button" style="margin-right:1em;">Load</button><button id="save-profile-button" class="sub-step-button">Save</button>
                        </div>
                        <input class="hidden" type="file" accept="*.json" id="past-profile-input"></input>
                        <div class="hidden" id="past-trial-save-div"></div>
                    </div>

                    <div id="calibration-view"  class="view" style="width:100%; flex-direction:column; align-items:center;">
                        Press the "Calibrate" button when ready.<br>
                        <button id="calibrate-button" class="sub-step-button">Calibrate</button>
                    </div>

                    <div id="target-data-view"  class="view" style="margin:0; padding:0;">
                        <div id="target-count-div" style="margin-left:0.5em; margin-bottom:1em;">
                            <span id="target-count">0</span>&nbsp;objects in view.
                        </div>
                        <div id="target-H-info" class="target-info-section" style="display:flex; flex-direction:column; align-items:center; justify-content:space-around;">
                            <div id="target-H-heading" style="display:flex; flex-direction:row; justify-content:space-evenly; align-items:center; width:90%; height:2em; text-align:center; color:rgb(104,0,52); border:2px solid rgb(104,0,52); font-weight:bold; font-size:110%;"><span>Target H</span><span>&#128393;</span></div>
                            <div id="target-H-cancel" class="hidden" style="display:flex; flex-direction:row; justify-content:space-evenly; align-items:center; width:90%; height:2em; text-align:center; color:rgb(104,0,52); border:2px solid rgb(104,0,52); font-weight:bold; font-size:110%;"><span>cancel</span></div>
                            <table style="margin-bottom:0.75em;">
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(104,0,52);">&#916;T Set: </span></td><td><span id="target-H-set-temp">--</span></td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(104,0,52);">&#916;T: </span></td><td><span id="target-H-current-temp">--</span>&#8451;</td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(104,0,52);">Status: </span></td><td><span id="target-H-heating-status">heating</span></td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(104,0,52);">(x,y): </span></td><td><span id="target-H-x-pos">--</span>mm,<span id="target-H-y-pos">--</span>mm</td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(104,0,52);">Moved: </span></td><td><span id="target-H-distance-moved">--</span>mm</td></tr>
                            </table>
                        </div>
                        <div id="target-U-info" class="target-info-section" style="display:flex; flex-direction:column; align-items:center; justify-content:space-around;">
                            <div id="target-U-heading" style="display:flex; flex-direction:row; justify-content:space-evenly; align-items:center; width:90%; height:2em; text-align:center; color:rgb(42,116,145); border:2px solid rgb(42,116,145); font-weight:bold; font-size:110%;"><span>Target U</span><span>&#128393;</span></div>
                            <div id="target-U-cancel" class="hidden" style="display:flex; flex-direction:row; justify-content:space-evenly; align-items:center; width:90%; height:2em; text-align:center; color:rgb(42,116,145); border:2px solid rgb(42,116,145); font-weight:bold; font-size:110%;"><span>cancel</span></div>
                            <table style="margin-bottom:0.75em;">
                                <!--<tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(42,116,145);">Ambient: </span></td><td><span id="target-U-current-temp">--</span>&#8451;</td></tr>-->
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(42,116,145);">(x,y): </span></td><td><span id="target-U-x-pos">--</span>mm,<span id="target-U-y-pos">--</span>mm</td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(42,116,145);">Moved: </span></td><td><span id="target-U-distance-moved">--</span>mm</td></tr>
                            </table>
                        </div>
                        <div style="width:100%; display:flex; flex-direction:row; justify-content:center;">
                            <button id="swap-target-button" class="sub-step-button hidden">Swap targets!</button>
                        </div>
                    </div>
                    <div id="safety-check-view" class="view" style="margin:0; padding:0;">
                        <div class="safety-step-text hidden">Are all operators wearing approved eye protection?</div>
                        <button class="safety-step-button hidden">Eye protection is on!</button>
                        <div class="completed-safety-step hidden"><img src="checkmark.png"><div>All operators are wearing eye protection.</div></div>
                        
                        <div class="safety-step-text hidden">Operators must keep their heads clear of the area underneath the laser shield.</div>
                        <button class="safety-step-button hidden">We will stay clear!</button>
                        <div class="completed-safety-step hidden"><img src="checkmark.png"><div>Operators won't look under shields.</div></div>
                        
                        <div class="safety-step-text hidden">The room must be kept closed and clearly marked as dangerous during tests.</div>
                        <button class="safety-step-button hidden">Door is closed, sign is up!</button>
                        <div class="completed-safety-step hidden"><img src="checkmark.png"><div>Room is closed and marked dangerous.</div></div>
                        
                        <div class="safety-step-text hidden">Reflective surfaces below the instrument could focus its laser in an unsafe direction.</div>
                        <button class="safety-step-button hidden">Instrument is on a matte surface!</button>
                        <div class="completed-safety-step hidden"><img src="checkmark.png"><div>Instrument is on a non-reflective surface.</div></div>
                        
                        <div class="safety-step-text hidden">Reflective tools can also potentially focus the laser in an unsafe direction.</div>
                        <button class="safety-step-button hidden">No reflective tools here!</button>
                        <div class="completed-safety-step hidden"><img src="checkmark.png"><div>All tools are non-reflective.</div></div>
                    </div>
                    <div id="empty-view"></div>
                    <div id="dynamic-content-view"></div>
                    <div></div>
                </div>
            </div>
            <div id="right-section-static-div" style="margin-left:0.75em; margin-right:0.75em; display:flex; flex-direction:column; justify-content:space-between;">
                <div id="indicators-div" style="display:flex; flex-direction:column; align-items:flex-start; margin-left: 0.75em; font-size:90%; height:88px; max-height:12vh;">
                    <div id="pc-connection-indicator" class="indicator-light" style="display:flex; flex-direction:row;"><div style="width:0.75em; height:0.75em; border:2px solid black; margin:2px; margin-right:.75em"></div><div>PC Connected</div></div>
                    <div id="disk-space-indicator" class="indicator-light" style="display:flex; flex-direction:row;"><div style="width:0.75em; height:0.75em; border:2px solid black; margin:2px; margin-right:.75em"></div><div>Disk OK: <span id="disk-space"></span></div></div>
                    <div id="laser-alive-indicator" class="indicator-light" style="display:flex; flex-direction:row;"><div style="width:0.75em; height:0.75em; border:2px solid black; margin:2px; margin-right:.75em"></div><div>Laser Alive</div></div>
                </div>
                <div id="action-button-container" style="width:90%; height:76px; max-height:10vh; display:flex; flex-direction:row; justify-content:space-around; align-items:flex-end;">
                    <button disabled id="secondary-action-button" style="font-weight:bold; display:flex; justify-content:center; align-items:center; text-align:center; sfont-size: 2.5vh; width:60px; max-width:4vw; height:90%; font-family:'Roboto Mono', monospace;">
                        <span style="width:100%; text-align:center;" id="secondary-action-button-span"><</span>
                    </button>
                    <button id="pause-resume-button" class="hidden" style="font-weight:bold; font-size: 2.5vh; display:flex; flex-direction:row; justify-content:center; align-items:center; width:225px; max-width:15vw; height:90%; font-family:'Roboto Mono', monospace;">
                        <span id="pause-resume-text">PAUSE TRIAL</span><span id="pause-symbol" style="font-weight:bold;">&nbsp;&#9612;&#9612;</span><span id="resume-symbol" class="hidden" style="font-weight:bold; font-size:130%;">&nbsp;&#9654;</span>
                    </button>
                    <button disabled id="primary-action-button" style="font-weight:bold; font-size: 2.5vh; display:flex; flex-direction:row; justify-content:center; align-items:center; width:225px; max-width:15vw; height:90%; font-family:'Roboto Mono', monospace;">
                        <span id="primary-action-button-span" style="font-weight:bold;">START TRIAL</span><span id="right-arrow-span" style="font-weight:bold;">&nbsp;></span><span id="stop-button-span" class="hidden">&nbsp;&#11035;</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">

// GLOBAL DATA MEMBERS

        // CONTROL & STATUS
        const BACKEND_CONFIG = {
            "output_dir": "/home/disco/trials",
            "thermal.option_save_every_n": 10,
            "thermal.option_process_every_n": 10,
            "visible.option_save_every_n": 50,
            "visible.option_process_every_n": 50,
            "visible.option_threshold": 50,
            "visible.option_min_area": 20,
            "visible.option_max_area": 90,
            "visible.option_blur_sigma": 1,
            "visible.option_mask_path": "mask.png",
            "laser.option_track_id": 1,
            "laser.option_target_temp": 0,
            "laser.option_enable": true, 
            "laser.option_rpi_address": "pi@10.0.2.108",
        }

        const SYSTEM_SETTINGS = {
            timeoutMilSec: 1000,
            heartbeatInterval: 50,
            statusDisplayUpdateInterval: 250,
            cameraUpdateInterval: 100,
            targetDataUpdateInterval: 100,
            targetDisplayUpdateInterval: 50,
            movementHistoryLength: 100,
            ip: '127.0.0.1',
            port: '5000',
            targetOutlineWidth: 0.5,
            visibleCamera: {
                xResolution: 400,
                yResolution: 300,
            },
            thermalCamera: {
                xResolution: 320,
                yResolution: 256,
            },
            computerVision: {
                minArea: 1,
                maxArea: 1,
                threshold: 0.5,
                maskPath: undefined,
                processEveryNthFrame: undefined,
                saveEveryNthFrame: undefined,
            },
        }
        var STATUS = {
            isArmed: "",
            isAlive: "",
            remoteEnabled: "",
            timeLastResponded: "",
            diskSpace: -1,
            isConnected: false,
            isPaused: false,
            elapsedTime: 0,
            timeInTrial: 0,
            laserIsSetToOn: false,
        };
        var TIMERS = {
            heartbeatTimer: null,
            statusDisplayUpdateTimer: null,
            cameraUpdateTimer: null,
            targetDisplayUpdateTimer: null,
            targetDataUpdateTimer: null,
        }
        var TRACKS = {}
        var TARGET_INFO = {
            temp: {
                hotspot: 0,
                atTemp: false,
                dStabilityThreshold: 0.01,
            },
            heated: {
                id: undefined,
                lastReported: 0,
                position: undefined,
                box: undefined,
                recentMovement: [],
                moved: 0,
            },
            unheated: {
                id: undefined,
                lastReported: 0,
                position: undefined,
                box: undefined,
                recentMovement: [],
                moved: 0,
            }, 
            reset: {
                id: undefined,
                lastReported: 0,
                position: undefined,
                box: undefined,
                recentMovement: [],
                moved: 0,
            },
            select: undefined,
        }
        const trialConfigValues = {
            'duration':[0,0.5,1,2,3,4,5,10,15,20,25,30],
            'temperature':[0,1,2,3,4,5,6,7,8,9,10,11],
            'power':[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100],
            'ambient':['disabled'],
        }
        var trialConfig = {
            'duration':0,
            'temperature':0,
            'power':0,
            'ambient':0,
        };
        var DISPLAY_STATE = {
            currentStep: 'home',
            cameraViewState: [false, false],
            targetBoxElements: {}, // format {id:isVisible; } 
        }
        const discoSteps = {
            'home':{
                'title':'Welcome to the Disco!',
                'instructions':'Choose "New Trial" to start a test run.',
                'view':'completed-trials-view',
                'content':'',
                'actionButtonText':'New Trial',
                'initialize':initHomeStep,
                'previousStep':false,
                'nextStep':'setup',
            },
            'setup':{
                'title':'Trial Setup',
                'instructions':'Load an existing profile or set new trial parameters.',
                'view':'trial-setup-view',
                'content':'',
                'actionButtonText':'Calibration',
                'initialize':initSetupStep,
                'previousStep':'home',
                'nextStep':'calibration',
            },
            'calibration':{
                'title':'Calibration',
                'instructions':'Place the calibration tool in the center of the arena, then position the disco machine so that the entire arena floor is unobscured in the mask to the left.',
                'view':'calibration-view',
                'content':'',
                'actionButtonText':'Safety Checks',
                'initialize':initCalibrationStep,
                'previousStep':'setup',
                'nextStep':'safety',
            },
            'safety':{
                'title':'Safety Checks',
                'instructions':'This instrument uses a 500mW 808nm NIR laser that can permanently damage eyes.',
                'view':'safety-check-view',
                'content':'',
                'actionButtonText':'Specimen Loading',
                'initialize':initSafetyStep,
                'previousStep':'calibration',
                'nextStep':'placement',
            },
            'placement':{
                'title':'Specimen Loading',
                'instructions':'Load, then tap headings to pick targets.',
                'content':``,
                'view':'target-data-view',
                'actionButtonText':'START TRIAL',
                'initialize':initPlacementStep,
                'previousStep':'safety',
                'nextStep':'trial',
                // Individual sub-steps: Remove the calibration tool and place the specimen to be heated in the arena. Now place the unheated specimen in the arena.
            },
            'trial':{
                'title':'Trial in Progress',
                'instructions':'',
                'view':'target-data-view',
                'content':'',
                'actionButtonText':'STOP TRIAL',
                'initialize':initTrialStep,
                'previousStep':false,
                'nextStep':'home',
            },
        }
        const dataIDs = {
            // "tempU" :"target-U-current-temp", // not currently used - u assumed at ambient, which we won't measure
            "xU"    :"target-U-x-pos",
            "yU"    :"target-U-y-pos",
            "movedU":"target-U-distance-moved",
            "setH"  :"target-H-set-temp",
            "tempH" :"target-H-current-temp", // this is in terms of the delta with ambient
            "xH"    :"target-H-x-pos",
            "yH"    :"target-H-y-pos",
            "movedH":"target-H-distance-moved",
        };

// FRONT-END FUNCTIONS

        // Button 0 = Visible, Button 1 = Thermal
        function updateCameraView(customViewState){
            let viewState = customViewState?customViewState:DISPLAY_STATE.cameraViewState;
            let showVisible = viewState[0];
            let showThermal = viewState[1];
            let visibleCamElement = document.getElementById('visible-cam-output');
            let thermalCamElement = document.getElementById('thermal-cam-output');
            let numActiveCamsViews = +showVisible + +showThermal;
            if(numActiveCamsViews == 1) {
                visibleCamElement.style.width = "100%";
                visibleCamElement.style.maxWidth = "120vh";
                thermalCamElement.style.width = "100%";
                thermalCamElement.style.maxWidth = "120vh";
            }
            if(numActiveCamsViews == 2) {
                visibleCamElement.style.width = "50%";
                //visibleCamElement.style.height = "50%";
                thermalCamElement.style.width = "50%";
                //thermalCamElement.style.height = "50%";
            }
            
            if(showVisible) {visibleCamElement.style.display = "flex";}
            else{visibleCamElement.style.display = "none";}

            if(showThermal) {thermalCamElement.style.display = "flex";} 
            else{thermalCamElement.style.display = "none";}
            updateTargetBoxes();
        }
        function updateCameraButtonView(){
            var camViewSelectButtons = document.getElementsByClassName('cam-select-button');
            var camViewSelectButton;
            for (let cameraViewStateIndex in DISPLAY_STATE.cameraViewState){
                camViewSelectButton = camViewSelectButtons[cameraViewStateIndex];
                if(DISPLAY_STATE.cameraViewState[cameraViewStateIndex]){
                    camViewSelectButton.classList.add('pressed-cam-select-button');
                } else {
                    camViewSelectButton.classList.remove('pressed-cam-select-button');
                }
            }

        }
        function showCameraViewButtons(visible){
            document.getElementById('camera-select-bar').style.display = visible ? 'flex':'none';
        }
        function pushCameraViewButton(index){            
            // If at least one camera is selected after toggling the view that was pressed, toggles that camera's visibility and update buttons:
            if(+!DISPLAY_STATE.cameraViewState[index] + +DISPLAY_STATE.cameraViewState[+!index]){
                DISPLAY_STATE.cameraViewState[index] = !DISPLAY_STATE.cameraViewState[index];
                updateCameraView();
                updateCameraButtonView();
            }
            // Otherwise, pressing the button again does nothing.
        }
        function clearPersistentAlerts() {
            alerts = document.getElementById('alert-message-board');
            while (alerts.firstChild) {
               alerts.removeChild(alerts.firstChild);
            }
        }
        function displayPersistentAlert(message, color) {
            clearPersistentAlerts();
            var messageDiv = document.createElement('div');
            messageDiv.appendChild(document.createTextNode(message));
            messageDiv.style = "position:absolute; top: 5vh; color:"+color+"; font-weight:bold; text-transform:capitalize; margin-left: 1em; font-size:5vh; background-color:rgba(0,0,0,0.5); padding-left:0.5em; padding-right:0.5em;";
            messageDiv.setAttribute("id", "alert"+document.getElementsByClassName('persistent-alert').length);
            messageDiv.setAttribute("class", "persistent-alert");
            messageDiv.appendChild(document.createElement('br'));
            document.getElementById('alert-message-board').appendChild(messageDiv);

        }
        function displayLaserArmedWarning(){
            displayPersistentAlert('WARNING: laser armed!', 'yellow');
        }
        function displayLaserActiveWarning(){
            displayPersistentAlert('DANGER: laser active!', 'red');
        }
        function clearStatusArea(){
            statusArea = document.getElementById('status-area');
            while (statusArea.firstChild) {
               statusArea.removeChild(statusArea.firstChild);
            }
        }
        function setStatusAreaText(newText){
            statusArea = document.getElementById('status-area');
            statusArea.innerText = newText;
        }
        function getSpan(id, contentNode) {
            var newSpan = document.createElement('span');
            newSpan.setAttribute('id', id);
            newSpan.appendChild(contentNode);
            return newSpan;
        }
        function getTimeStamp(seconds) {
            return "" + Math.floor(seconds / 60) + ":" + ("0" + Math.floor(seconds) % 60).slice(-2); 
        }
        function showTrialProgress(secElapsed, secTotal){
            clearStatusArea();

            var statusMessage = document.createTextNode("Disco in progress... ");

            var progressBar = document.createElement('progress');
            progressBar.setAttribute('id', 'progress-bar');
            progressBar.setAttribute('value', secElapsed*1000);
            progressBar.setAttribute('max', secTotal*1000);

            var elapsedTimeDisplay = document.createTextNode(getTimeStamp(secElapsed));
            var statusSpacer = document.createTextNode(" / ");
            var trialLengthDisplay = document.createTextNode(getTimeStamp(secTotal));

            statusArea.appendChild(getSpan('status-message-span', statusMessage));
            statusArea.appendChild(getSpan('progress-bar-span', progressBar));
            statusArea.appendChild(getSpan('elapsed-time-span', elapsedTimeDisplay));
            statusArea.appendChild(getSpan('status-spacer-span', statusSpacer));
            statusArea.appendChild(getSpan('trial-length-span', trialLengthDisplay));
        }
        function setStatusAreaColor(color){
            document.getElementById('status-area').style.backgroundColor=color;
        }
        // isOn = true for green, isOn = false for red
        function setIndicator(index, isOn){ 
            var indicator=document.getElementsByClassName('indicator-light')[index].firstChild.style.backgroundColor = isOn ? "green" : "red";
        }
        // clears specified indicator by setting background to transparent
        function clearIndicator(index) {
            var indicator=document.getElementsByClassName('indicator-light')[index].firstChild.style.backgroundColor = "transparent";
        }
        function setPrimaryActionButtonText(text){
            document.getElementById('primary-action-button-span').innerHTML = text;
        }
        function setStepTitleText(newTitle){
            document.getElementById('step-title').innerHTML = newTitle;
        }
        function setInstructionText(newInstructions){
            document.getElementById('instruction-text').innerHTML = newInstructions;
            showElement('instruction-text', true);
        }
        function setView(prevViewId, newViewId){
            document.getElementById(prevViewId).style.display = 'none';            
            document.getElementById(newViewId).style.display = 'block';
        }
        function setContent(outerHtml){
            document.getElementById('dynamic-content-view').outerHTML = '<div id="dynamic-content-view">'+outerHtml+'</div>';
        }
        function setStep(stepKey) {
            if(stepKey){
                var hiddenElements = document.getElementsByClassName('hidden');
                for (let i = 0; i < hiddenElements.length; i++) {
                    hiddenElements[i].style.display = "none";
                }
                var prevStepObj = discoSteps[DISPLAY_STATE.currentStep];
                DISPLAY_STATE.currentStep = stepKey;
                var currentStepObj = discoSteps[stepKey];
                setStepTitleText(currentStepObj.title);
                setView(prevStepObj.view, currentStepObj.view);
                if(currentStepObj.instructions) {
                    setInstructionText(currentStepObj.instructions);
                }
                setContent(currentStepObj.content);
                setPrimaryActionButtonText(currentStepObj.actionButtonText);
                enableButton("secondary-action-button", currentStepObj.previousStep);
                clearStatusArea();
                setStatusAreaColor("black");
                if(stepKey == 'trial') {
                    document.getElementById('right-arrow-span').innerHTML = '';
                } else {
                    document.getElementById('right-arrow-span').innerHTML = '&nbsp;>';
                }
                currentStepObj.initialize();
            }
        }
        function pushBackButton(){
            setStep(discoSteps[DISPLAY_STATE.currentStep].previousStep);
        }
        function pushActionButton(){;
            setStep(discoSteps[DISPLAY_STATE.currentStep].nextStep);
        }
        function enableButton(buttonId, isEnabled){
            if(isEnabled) {
                document.getElementById(buttonId).removeAttribute('disabled');
            } else {
                document.getElementById(buttonId).setAttribute('disabled','true');            
            }
        }
        function showElement(id, shown=true) {
            document.getElementById(id).style.display = shown ? "flex" : "none";
        }
        function showElements(selector, shown=true) {
            let elements = document.querySelectorAll(selector);
            for (let i = 0; i < elements.length; i++) {
                elements[i].style.display = shown ? "flex":"none";
            }
        }
        function setProfile(profileObj) {
            for (let key in profileObj.options) {
                if (trialConfigValues[key] == undefined) {
                    setStatusAreaColor('rgb(200,180,0)');
                    setStatusAreaText('Warning: the loaded object contains additional, unused settings or values. This may indicate a malformed settings file.');
                } else {
                    trialConfigValues[key] = profileObj.options[key];
                }
            }
            let loadedSelectionKeys = Object.keys(profileObj.selections);
            for (let loadedSelectionKeyIndex in loadedSelectionKeys) {
                let loadedSelectionKey = loadedSelectionKeys[loadedSelectionKeyIndex];
                if (Object.keys(trialConfig).indexOf(loadedSelectionKey) < 0) {
                    setStatusAreaColor('rgb(200,180,0)');
                    setStatusAreaText('Warning: the loaded object contains additional, unused settings or values. This may indicate a malformed settings file.');
                } 
            }
            let trialConfigOptionKeys = Object.keys(trialConfigValues);
            for (let optionKeyIndex in trialConfigOptionKeys) {
                let currOptionKey = trialConfigOptionKeys[optionKeyIndex];
                if (Object.keys(profileObj.options).indexOf(currOptionKey) < 0 || Object.keys(trialConfig).indexOf(currOptionKey) < 0) {
                    setStatusAreaColor('rgb(200,180,0)');
                    setStatusAreaText('Warning: the loaded object contains only a subset of active config settings. This may indicate a malformed settings file.');
                }
            }
            let trialConfigKeys = Object.keys(trialConfig);
            for (let selectionKeyIndex in trialConfigKeys) {
                let selectionKey = trialConfigKeys[selectionKeyIndex];
                if (profileObj.selections[selectionKey] < 0 || profileObj.selections[selectionKey] > trialConfigValues[selectionKey].length - 1) {
                    setStatusAreaColor("orange");
                    setStatusAreaText("Loaded profile contained trial setting selections incompatible with its saved options. These were omitted.");
                } else {
                    trialConfig[selectionKey] = profileObj.selections[selectionKey];
                }
            }
            if (STATUS.diskSpace < trialConfigValues.duration[trialConfig.duration]) {
                setStatusAreaColor('orange');
                setStatusAreaText('Not enough disk space, duration must be ' + Math.floor(STATUS.diskSpace) + ' or less.');
                trialConfig.duration = 0;
                while(trialConfig.duration < trialConfigValues.duration.length - 2 && trialConfigValues.duration[trialConfig.duration + 1] < STATUS.diskSpace) {
                    trialConfig.duration += 1;
                }
                return;
            }
            updateSettingsDisplay();
        }
        function saveProfile(){
            let date = String(new Date()).split(' ');
            let dateString = [date[3],date[1]+date[2],date[4]].join('_').replace(/:/g,'-');
            var profileData = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({"options":trialConfigValues, "selections":trialConfig,}));
            let profileJSON = JSON.stringify({"options":trialConfigValues, "selections":trialConfig,}, null, 1);
            let saveProfileEl = document.getElementById('past-trial-save-div');
            saveProfileEl.innerHTML = '<a id="save-profile-link" href="data:' + profileData + '" download="settings_'+dateString+'.json">download JSON</a>';
            document.getElementById('save-profile-link').click();
        }
        function openTrialFolder(){
            sendCommand('BROWSE');
        }
        function listenForTestProfileFileInputChange(){
            var pastProfileInput = document.getElementById('past-profile-input');
            pastProfileInput.addEventListener('change', function (e) { 
                var pastProfileFile = pastProfileInput.files[0];
                let selectedProfileName = pastProfileFile.name; 
                var fileReader = new FileReader();
                fileReader.onload = function (e) { 
                    setProfile(JSON.parse(fileReader.result)); 
                }
                fileReader.readAsText(pastProfileFile);
            }, false);
        }
        function pickExistingProfile(){
            document.getElementById('past-profile-input').click();
        }
        function toggleSetupEntryDisplay(datumId){
            let param = datumId.split('-')[0];
            let entry = document.getElementById('setup-'+param+'-entry');
            if (entry.style.display === "none") {
                let allEntries = document.getElementsByClassName('setup-datum-entry');
                for (let i = 0; i < allEntries.length; i++) {
                    allEntries[i].style.display = "none";
                }
                document.addEventListener('click', (e)=> {
                    e.target.removeEventListener(e.type, arguments.callee);
                    let classes = e.target.classList;
                    if (! ( classes.contains('setup-datum-entry') || classes.contains('setup-entry-cur-val') || classes.contains('plus-minus-button'))) {
                        let allEntries = document.getElementsByClassName('setup-datum-entry');
                        for (let i = 0; i < allEntries.length; i++) {
                            allEntries[i].style.display = "none";
                        }
                    }
                }, 'false');
                entry.style.display = "flex";
                updateSettingsDisplay();
            } else {
                entry.style.display = "none";
            }
        }
        function updateSettingsDisplay() {
            // value range logic
            for (let key in trialConfig) {
                let valIndex = trialConfig[key];
                let val = trialConfigValues[key][valIndex];
                if(valIndex > 0) {
                    document.getElementById(key+'-decrement-button').removeAttribute('disabled');
                } else {
                    document.getElementById(key+'-decrement-button').setAttribute('disabled', '');
                }
                if(valIndex < trialConfigValues[key].length - 1) {
                    document.getElementById(key+'-increment-button').removeAttribute('disabled');
                } else {
                    document.getElementById(key+'-increment-button').setAttribute('disabled', '');
                }
            }
                // check duration vs disk space
            if (STATUS.isConnected && STATUS.diskSpace < 1 ) {
                enableButton("primary-action-button", false);
                setStatusAreaColor("orange");
                setStatusAreaText("Disk is full. Please clear space before starting a new trial.");
            } else if (STATUS.isConnected && trialConfig.duration < trialConfigValues.duration.length - 1 && 
                    (trialConfigValues.duration[trialConfig.duration + 1] > STATUS.diskSpace || trialConfigValues.duration[trialConfig.duration] > STATUS.diskSpace)) {
                enableButton("duration-increment-button", false);
                setStatusAreaText('Only ' + Math.floor(STATUS.diskSpace) + ' minutes of disk space available.');
            }
                // set to unheated if power is 'off'
            if (trialConfig.power == 0 && trialConfig.temperature > 0) {
                trialConfig.temperature = 0;
                updateSettingsDisplay();
            }
            
            // text formatting
            let durationString = trialConfig.duration == 0 ? "manual stop" : trialConfigValues.duration[trialConfig.duration] + " min";
            document.getElementById('setup-duration-display').innerText = durationString;
            document.getElementById('setup-duration-cur-val').innerText = durationString;

            let tempString = "unheated";
            if (trialConfig.temperature == trialConfigValues.temperature.length - 1) {tempString = "max possible";}
            else if (trialConfig.temperature > 0) {tempString = trialConfigValues.temperature[trialConfig.temperature] + '&#8451;';}
            document.getElementById('setup-temperature-display').innerHTML = tempString;
            document.getElementById('setup-temperature-cur-val').innerHTML = tempString;

            let powString = trialConfig.power == 0 ? "off" : trialConfigValues.power[trialConfig.power] + "%";
            document.getElementById('setup-power-display').innerText = powString;
            document.getElementById('setup-power-cur-val').innerText = powString;

            let ambString = trialConfig.ambient == 0 ? "disabled" : trialConfigValues.ambient[trialConfig.ambient] + '&#8451;';
            document.getElementById('setup-ambient-display').innerHTML = ambString;
            document.getElementById('setup-ambient-cur-val').innerHTML = ambString;

        }
        function startTrial() {
            BACKEND_CONFIG["laser.option_track_id"] = TARGET_INFO.heated.id;
            BACKEND_CONFIG["laser.option_enable"] = true;
            sendConfig();
        }
        function stopTrialManually(){
            STATUS.isPaused = false;
            showElement("pause-symbol", true);
            showElement("resume-symbol", false);
            document.getElementById("pause-resume-text").innerText = "PAUSE TRIAL";
            showElement("pause-resume-button", false);
            showElement("stop-button-span", false);
            showElement("right-arrow-span", true);
            showElement("secondary-action-button", true);   
            stopLaser();
            clearTarget(true);
            clearTarget(false);
            clearInterval(TIMERS.heartbeatTimer);
            clearStatusArea();
            document.getElementById('primary-action-button').removeEventListener('click', stopTrialManually);
            setStatusAreaText('Trial stopped manually at '+getTimeStamp(STATUS.timeInTrial)+'.');
            setStatusAreaColor('purple');
        }
        function concludeTrial(){
            stopTrialManually();
            setStatusAreaText('Trial concluded successfully.');
            setStatusAreaColor('green');
            setStep('home');
        }
        function terminateTrialWithError(errorMessage){
            stopLaser();
            clearInterval(TIMERS.heartbeatTimer);
            clearStatusArea();
            document.getElementById('primary-action-button').removeEventListener('click', stopTrialManually);
            setStatusAreaText('Trial terminated at '+getTimeStamp(STATUS.timeInTrial)+' due to error: '+errorMessage);
            setStatusAreaColor('red');
        }
        function pauseOrResumeTrial(){
            STATUS.isPaused = !STATUS.isPaused;

            if(STATUS.isPaused) {
                stopLaser();
                setStepTitleText('Trial Paused');
                document.getElementById('pause-resume-text').innerText = "RESUME TRIAL";
                showElement('resume-symbol', true);
                showElement('pause-symbol', false);
            } else {
                startLaser();
                setStepTitleText('Trial in Progress');
                document.getElementById('pause-resume-text').innerText = "PAUSE TRIAL";
                showElement('pause-symbol', true);
                showElement('resume-symbol', false);
            }
        }
        function updateTargetBoxes() {
            // Clears all target boxes then draws boxes for all currently detected tracks.
            // Color is set if trackId matches with a current target, else it is gray as a potential target

            for (trackId in DISPLAY_STATE.targetBoxElements) {
                DISPLAY_STATE.targetBoxElements[trackId].remove();
            }
            for (var trackId in TRACKS) {
                let color = "grey";
                if (trackId == TARGET_INFO.heated.id) {
                    color = "rgb(104,0,52)";
                }
                else if (trackId == TARGET_INFO.unheated.id) {
                    color = "rgb(42,116,145)";
                }
                drawTargetBox(
                    trackId, color,
                    TRACKS[trackId].box[0], 
                    TRACKS[trackId].box[1], 
                    TRACKS[trackId].center[0], 
                    TRACKS[trackId].center[1], 
                    TRACKS[trackId].box[2], 
                    TRACKS[trackId].box[3], 
                );
            }
        }
        function drawTargetBox(trackId, colorString, x1, y1, xt, yt, x2, y2) {
            if(xt < x1 || xt > x2 || yt < y1 || yt > y2) {
                console.log ("given target is not in specified box???");
            }
            if(x1 > x2 || y1 > y2) {                
                console.log ("box coordinates invalid, can't draw box...");
                return;
            }
            let existingEl = document.getElementById("box-"+trackId);
            if(existingEl) {
                existingEl.remove();
            }
            let boxEl = document.createElement('div');
            boxEl.id = "box-"+trackId;
            boxEl.style.outline = SYSTEM_SETTINGS.targetOutlineWidth+"vh solid "+colorString;
            boxEl.style['outline-offset'] = -1 * SYSTEM_SETTINGS.targetOutlineWidth + "vh";
            boxEl.style.position = "absolute"; 
            boxEl.style["z-index"] += 10000;


            let x = 0, y = 1;
            //  img size in vw / img size in camera pixels = vu per cam pixel
            let imgEl = document.getElementById('visible-cam-output');
            let scaleFactor = 100 * imgEl.clientWidth / window.innerWidth / SYSTEM_SETTINGS.visibleCamera.xResolution;
            let boxCenterVW = [scaleFactor * (x1 + x2)/2, scaleFactor * (y1 + y2)/2];
            let boxSizeVW = [scaleFactor * (x2 - x1), scaleFactor * (y2 - y1)];
            let targetPositionVW = [scaleFactor * (xt), scaleFactor * yt];
            let imgOffset = [100 * imgEl.offsetLeft / window.innerWidth , 100 * imgEl.offsetTop / window.innerWidth];
           
            boxEl.style.width = boxSizeVW[x] + "vw";
            boxEl.style.height = boxSizeVW[y] + "vw";
            boxEl.style.left = imgOffset[x] + x1 * scaleFactor + "vw";
            boxEl.style.top = imgOffset[y] + y1 * scaleFactor + "vw";

            DISPLAY_STATE.targetBoxElements[trackId] = boxEl;
            document.getElementById('left-section').prepend(boxEl);


            // align the crosshairs if doing that...
        }
        function selectTrackAsTarget(trackId, isHeated) {
            let hId = TARGET_INFO.heated.id;
            let uId = TARGET_INFO.unheated.id;
            let tInfo = TARGET_INFO[isHeated ? "heated" : "unheated"];
            if (tInfo.id == trackId) {
                return;
            }
            if(isHeated && trackId == uId || !isHeated && trackId == hId) {
                let oldHeatedTarget = JSON.parse(JSON.stringify(TARGET_INFO.heated));
                TARGET_INFO.heated = JSON.parse(JSON.stringify(TARGET_INFO.unheated));
                TARGET_INFO.unheated = oldHeatedTarget;
            } else {
                clearTarget(isHeated);
                TARGET_INFO[isHeated ? "heated" : "unheated"].id = trackId;
            }
            updateTargetInfoFromData();
            BACKEND_CONFIG["laser.option_track_id"] = TARGET_INFO.heated.id;
            sendConfig();
        }
        function clearTarget(isHeated) {
            TARGET_INFO[isHeated ? "heated" : "unheated"] = JSON.parse(JSON.stringify(TARGET_INFO.reset));
        }
        function listenCancelPick(e) {
            cancelPick();
            e.stopPropagation();
            setInstructionText('Action canceled, target not chosen.');
        }
        function cancelPick() {
            TARGET_INFO.select = undefined;
            showElement('target-H-heading', true);
            showElement('target-H-cancel', false);
            showElement('target-U-heading', true);
            showElement('target-U-cancel', false);
        }
        function pickHeated(e) {
            if (TARGET_INFO.select == undefined) {
                TARGET_INFO.select = true;
                setInstructionText('Now pick the heated target on the display.');
                showElement('target-H-heading', false);
                showElement('target-H-cancel', true);
                document.addEventListener('click', handleTargetSelection, true);
            } else {
                TARGET_INFO.select = undefined;
                listenCancelPick(e);
            }
        }
        function pickUnheated(e) {
            if (TARGET_INFO.select == undefined) {
                TARGET_INFO.select = false;
                setInstructionText('Now pick the unheated target on the display.');
                showElement('target-U-heading', false);
                showElement('target-U-cancel', true);
                document.addEventListener('click', handleTargetSelection, true);
            } else {
                TARGET_INFO.select = undefined;
                listenCancelPick(e);
            }
        }
        var x;
        function handleTargetSelection(e) {
            document.removeEventListener('click', handleTargetSelection, true);
            e.stopPropagation();
            x = e;
            let isHeated = TARGET_INFO.select;
            if (e.target.id.split('-')[0] == "box") {
                let trackId = e.target.id.split('-')[1];
                selectTrackAsTarget(trackId, isHeated);
                setInstructionText((isHeated ? "Heated" : "Unheated") + ' target set.');
                TARGET_INFO.select = undefined;
                showElement('target-H-heading', true);
                showElement('target-H-cancel', false);
                showElement('target-U-heading', true);
                showElement('target-U-cancel', false);
            } else {
                TARGET_INFO.select = undefined;
                listenCancelPick(e);
                setInstructionText('Try again.');
            }
        }



    // INITIALIZE THE VARIOUS STEPS
        function initHomeStep(){
        }
        function initSetupStep(){
            showCameraViewButtons(true);
            updateCameraView();
            clearStatusArea();
            setStatusAreaColor('black');
        }
        function initCalibrationStep(){
            updateCameraView([true,false]);
            updateCameraButtonView();
            showCameraViewButtons(false);
            enableButton("primary-action-button", true);
        }
        function initPlacementStep(){
            let tempString = "unheated";
            if (trialConfig.temperature == trialConfigValues.temperature.length - 1) {tempString = "max possible";}
            else if (trialConfig.temperature > 0) {tempString = trialConfigValues.temperature[trialConfig.temperature] + '&#8451;';}
            document.getElementById('target-H-set-temp').innerHTML = tempString;
            showCameraViewButtons(true);
            updateCameraView();
            enableButton("primary-action-button", true);
        }
        function initSafetyStep(){
            showCameraViewButtons(true);
            updateCameraView();
            enableButton("primary-action-button", false);
            document.getElementsByClassName('safety-step-text')[0].style.display = "flex";
            document.getElementsByClassName('safety-step-button')[0].style.display = "flex";
            if(trialConfigValues.temperature[trialConfig.temperature] == 0 && !STATUS.isArmed && !STATUS.isAlive) {
                setInstructionText("You are conducting an unheated trial, and the laser is disarmed. It is safe to proceed without further checks.");
                document.getElementsByClassName("safety-step-text")[0].style.display = "none";
                document.getElementsByClassName("safety-step-button")[0].style.display = "none";
                enableButton("primary-action-button", true);
            }
            BACKEND_CONFIG["laser.option_enable"] = STATUS.laserIsSetToOn;
            BACKEND_CONFIG["laser.option_target_temp"] = trialConfig.temperature;
            BACKEND_CONFIG["laser.option_track_id"] = TARGET_INFO.heated.id;            
        }
        function initTrialStep(){
            if (!STATUS.isConnected) {
                setStep('safety');
                setStatusAreaColor('orange');
                setStatusAreaText('Warning: PC is disconnected, cannot start trial!');
                return;
            }
            else if (!STATUS.isArmed && trialConfig.temperature > 0) {
                setStep('safety');
                setStatusAreaColor('orange');
                setStatusAreaText('Warning: laser is not armed, cannot perform heated trial!');
                return;
            } else if (STATUS.diskSpace < trialConfigValues.duration[trialConfig.duration]) {
                setStep('setup');
                setStatusAreaColor('orange');
                setStatusAreaText('Not enough disk space, please select a duration less than ' + Math.floor(STATUS.diskSpace));
                return;
            }
            showElement("secondary-action-button",false);
            showElement("pause-resume-button", true);
            showElement("right-arrow-span", false);
            showElement("stop-button-span", true);
            
            startLaser();
            
            STATUS.elapsedTime = 0;
            STATUS.timeInTrial = 0;
            // Convert from minutes to seconds and account for manually stopped trial:
            var trialDurationSeconds = trialConfig.duration > 0 ? 60 * trialConfigValues.duration[trialConfig.duration] : 60 * 60 * 24;
            let startTime = new Date();
            let intervalTime = 0;
            TIMERS.heartbeatTimer = setInterval(function(){
                intervalTime = (new Date() - startTime) / 1000 - STATUS.elapsedTime;
                STATUS.elapsedTime += intervalTime;
                if (!STATUS.isPaused) {
                    if(STATUS.laserIsSetToOn) {
                        sendHeartBeat();
                    }
                    STATUS.timeInTrial += intervalTime;
                    showTrialProgress(STATUS.timeInTrial, trialDurationSeconds);
                }
                updateSystemStatusDisplay();
                if (STATUS.timeInTrial > trialDurationSeconds) {
                    concludeTrial();
                }
            }, STATUS.heartbeatInterval);
            document.getElementById('primary-action-button').addEventListener('click',stopTrialManually,false);
        }
        function initializeAppUI(){

            // Button 0 = visible, Button 1 = Thermal
            DISPLAY_STATE.cameraViewState = [false, false];
            pushCameraViewButton(0);
            pushCameraViewButton(1);
            setStep('home');
            enableButton("primary-action-button", true);

            document.getElementById('visible-button').addEventListener('click', ()=>{pushCameraViewButton(0);}, false);
            document.getElementById('thermal-button').addEventListener('click', ()=>{pushCameraViewButton(1);}, false);
            document.getElementById('primary-action-button').addEventListener('click', pushActionButton, false);
            document.getElementById('secondary-action-button').addEventListener('click', pushBackButton, false);
            document.getElementById('pause-resume-button').addEventListener('click', pauseOrResumeTrial, false);


            // One-time initialization for steps:

            // home
            document.getElementById('trial-output-path').innerText = BACKEND_CONFIG.output_dir;

            // setup
            listenForTestProfileFileInputChange();
            document.getElementById('load-profile-button').addEventListener('click',()=>{document.getElementById('past-profile-input').click();}, false);
            document.getElementById('save-profile-button').addEventListener('click',saveProfile, false);
                // show / hide config entry fields
            let setupData = document.getElementsByClassName('setup-datum');
            for (let i = 0; i < setupData.length; i++) {
                if (! setupData[i].classList.contains('disabled-datum')) {
                    setupData[i].addEventListener('click', ()=>{
                        toggleSetupEntryDisplay(setupData[i].id);
                    },false);
                }
            }
                // Add plus / minus button handlers
            let entries = document.getElementsByClassName('setup-datum-entry');
            for (let nodeIndex = 0; nodeIndex < entries.length; nodeIndex++) {
                entries[nodeIndex].firstElementChild.addEventListener('click',(e)=>{
                    e.stopPropagation();
                    trialConfig[entries[nodeIndex].id.split('-')[1]] -= 1;
                    updateSettingsDisplay();
                },true);
                entries[nodeIndex].lastElementChild.addEventListener('click',(e)=>{
                    e.stopPropagation();
                    trialConfig[entries[nodeIndex].id.split('-')[1]] += 1;
                    updateSettingsDisplay();
                },true);
            }

            // calibration
            document.getElementById('calibrate-button').addEventListener('click',()=>{calibrateSystem();},false);

            // placement
            document.getElementById('target-H-info').addEventListener('click', pickHeated, false);
            document.getElementById('target-U-info').addEventListener('click', pickUnheated, false);
            document.getElementById('target-H-cancel').addEventListener('click', cancelPick, true);
            document.getElementById('target-U-cancel').addEventListener('click', cancelPick, true);

            // safety
            var safetyStepsCompleted = document.getElementsByClassName('completed-safety-step');
            var safetyStepTexts = document.getElementsByClassName('safety-step-text');
            var safetyStepButtons = document.getElementsByClassName('safety-step-button');
            for (let i = 0; i < safetyStepTexts.length; i++) {
                safetyStepsCompleted[i].style.display = "none";
                safetyStepTexts[i].style.display = "none";
                safetyStepButtons[i].style.display = "none";

                safetyStepButtons[i].addEventListener('click',()=>{
                    safetyStepTexts[i].style.display = "none";
                    safetyStepButtons[i].style.display = "none";
                    safetyStepsCompleted[i].style.display = "flex";
                    if(i < safetyStepTexts.length - 1){
                        safetyStepTexts[i+1].style.display = "flex";
                        safetyStepButtons[i+1].style.display = "flex";
                    } else {
                        enableButton("primary-action-button", true);
                    }
                },false);
            }

            //trial


        }
        initializeAppUI();


// SYNCHRONIZATION

        function refreshCameraImages() {
            let randNum = Math.floor(Math.random()*Math.pow(10,10));
            document.getElementById('visible-cam-output').src = 'visible_cam_output.png?'+randNum;
            document.getElementById('thermal-cam-output').src = 'thermal_cam_output.png?'+randNum;
        }
        TIMERS.cameraUpdateTimer = setInterval(refreshCameraImages, SYSTEM_SETTINGS.cameraUpdateInterval);

        function updateSystemStatusDisplay() {
            if (new Date().getTime() - STATUS.timeLastResponded > SYSTEM_SETTINGS.timeoutMilSec) {
                if(STATUS.isConnected) {
                    STATUS.isConnected = false;
                    setIndicator(0, false);
                    console.log('device was disconnected at time ' + new Date().getTime());
                }
            } else {
                STATUS.isConnected = true;
                setIndicator(0, true);
            }
            if (STATUS.laserIsSetToOn || STATUS.isAlive) {
                displayLaserActiveWarning();
                if (STATUS.isAlive) {
                    setIndicator(2, true);
                } else { setIndicator(2, false); }
            } else if (STATUS.isArmed) {
                displayLaserArmedWarning();
            }
            document.getElementById("disk-space").innerText = STATUS.diskSpace;
            if (STATUS.diskSpace < 1) {
                setIndicator(1, false);
                terminateTrialWithError("Ran out of disk space.");
            } else { setIndicator(1, true); }

        }
        TIMERS.statusDisplayUpdateTimer = setInterval(updateSystemStatusDisplay, SYSTEM_SETTINGS.statusDisplayUpdateInterval);

        function updateTargetInfoFromData() {
            let hi = TARGET_INFO.heated;
            let ht = TRACKS[hi.id];
            // if the heated track exists
            if (ht) {
                if(hi.position) {
                    let dxh = ht.center[0] - TARGET_INFO.heated.position[0];
                    let dyh = ht.center[1] - TARGET_INFO.heated.position[1];
                    // in pixels
                    let thisMove = Math.floor(100 * Math.sqrt(Math.pow(dxh,2)+Math.pow(dyh,2))) / 100;
                    //convert to mm
                    thisMove = Math.floor(100 * thisMove / 3) / 100;
                    TARGET_INFO.heated.recentMovement.push(thisMove);
                    TARGET_INFO.heated.moved += thisMove;
                    if (TARGET_INFO.heated.recentMovement.length > SYSTEM_SETTINGS.movementHistoryLength) {
                        TARGET_INFO.heated.moved -= TARGET_INFO.heated.recentMovement[0];
                        TARGET_INFO.heated.recentMovement = TARGET_INFO.heated.recentMovement.slice(1);
                    }
                } else {
                    TARGET_INFO.heated.recentMovement = [];
                    TARGET_INFO.heated.moved = 0;
                }
                if (hi.id) {
                    TARGET_INFO.heated.lastReported = ht.timestamp;
                    TARGET_INFO.heated.position = ht.center;
                    TARGET_INFO.heated.box = ht.box;
                }
            } else {
                clearTarget(true);
            }
            let ui = TARGET_INFO.unheated;
            let ut = TRACKS[ui.id];
            if(ut) {
                if(ui.position) { 
                    let dxu = ut.center[0] - TARGET_INFO.unheated.position[0]
                    let dyu = ut.center[1] - TARGET_INFO.unheated.position[1]
                    // in pixels
                    let thisMoveU = Math.floor(100 * Math.sqrt(Math.pow(dxu,2)+Math.pow(dyu,2))) / 100;
                    //convert to mm
                    thisMoveU = Math.floor(100 * thisMoveU / 3) / 100;
                    TARGET_INFO.unheated.recentMovement.push(thisMoveU);
                    TARGET_INFO.unheated.moved += thisMoveU;
                    if (TARGET_INFO.unheated.recentMovement.length > SYSTEM_SETTINGS.movementHistoryLength) {
                        TARGET_INFO.unheated.moved -= TARGET_INFO.unheated.recentMovement[0];
                        TARGET_INFO.unheated.recentMovement = TARGET_INFO.unheated.recentMovement.slice(1);
                    }
                } else {
                    TARGET_INFO.unheated.recentMovement = [];
                    TARGET_INFO.unheated.moved = 0;
                }
                if (ui.id) {
                    TARGET_INFO.unheated.lastReported = ut.timestamp;
                    TARGET_INFO.unheated.position = ut.center;
                    TARGET_INFO.unheated.box = ut.box;
                }
            } else {
                clearTarget(false);
            }
        }

        TIMERS.targetDataUpdateTimer = setInterval(()=>{
                updateDataFromInstrument(); 
                updateTargetInfoFromData(); 
                updateTargetBoxes(); 
                updateTargetInfoDisplay();
            }, SYSTEM_SETTINGS.targetDataUpdateInterval);
        
        function updateTargetInfoDisplay(){
            // count
            document.getElementById("target-count").innerText = Object.keys(TRACKS).length;

            // position
            document.getElementById("target-H-x-pos").innerText = TARGET_INFO.heated.position ? (TARGET_INFO.heated.position[0]).toFixed(1) : "--";
            document.getElementById("target-H-y-pos").innerText = TARGET_INFO.heated.position ? (TARGET_INFO.heated.position[1]).toFixed(1) : "--";
            document.getElementById("target-U-x-pos").innerText = TARGET_INFO.unheated.position ? (TARGET_INFO.unheated.position[0]).toFixed(1) : "--";
            document.getElementById("target-U-y-pos").innerText = TARGET_INFO.unheated.position ? (TARGET_INFO.unheated.position[1]).toFixed(1) : "--";
            document.getElementById("target-H-distance-moved").innerText = TARGET_INFO.heated.position ? (TARGET_INFO.heated.moved).toFixed(1) : "--";
            document.getElementById("target-U-distance-moved").innerText = TARGET_INFO.unheated.position ? (TARGET_INFO.unheated.moved).toFixed(1) : "--";

            // temp and moved
            document.getElementById("target-H-current-temp").innerText = TARGET_INFO.temp.hotspot;
            document.getElementById("target-H-heating-status").innerText = TARGET_INFO.heated.id ? (trialConfig.temperature == 0 || TARGET_INFO.temp.atTemp ? "stable" : "heating") : "--";
        }

//********************************************************************
// BACKEND INTERFACE FUNCTIONS

        /*
        commands: START_LASER, STOP_LASER, CALIBRATE_SYSTEM, SWAP_TARGETS, BEAT
        requests: GET_TARGET_INFO, GET_STATUS
        */

        function sendCommand(command, payload) {
            
            // this line specs the command API - http://ip_address:port/commands/SOME_COMMAND
            var commandPromise = false;
            try {
                commandPromise = fetch('http://'+SYSTEM_SETTINGS.ip+':'+SYSTEM_SETTINGS.port+'/commands/'+command, {method:"post", body: payload ? JSON.stringify(payload) : String(new Date().getTime())})
                .then(function(response) {
                    if (response.status == "200") {
                        // OK
                        console.log('Command ',command,' executed successfully.');
                    }
                    if (response.status == "202") {
                        // ACCEPTED
                        setStatusAreaText(command + " command received, pending...");
                        setStatusAreaColor('rgb(200,180,0)');
                    }
                    if (response.status == "408") {
                        // TIMEOUT
                        setStatusAreaText(command + " command timed out.");
                        setStatusAreaColor('red');
                    }
                    if (response.status == "500") {
                        // INTERNAL SERVER ERROR
                        setStatusAreaText("Server failure, failed to issue "+command+" command.");
                        setStatusAreaColor('red');
                    }
                    if (response.status == "503") {
                        // SERVICE UNAVAILABLE
                        setStatusAreaText("Service unavailable, failed to issue "+command+" command.");
                        setStatusAreaColor('red');
                    }
                    return response.json();
                }).catch( (err) => {
                        setStatusAreaText("Command "+command+" not sent because PC is disconnected.");
                        setStatusAreaColor("orange");
                });
            } catch (err) {
                console.log("Caught: ", err.message);
            }
        }

        function sendConfig() {
            sendCommand('RECONFIGURE', BACKEND_CONFIG);
        }

        function calibrateSystem(){
            // take this out? requests some alignment image to check that coordinates are overlapped? 
            // I think that would be useful to make sure nothing is awry and allow user calibration.
            // maybe calibration.png or something
            sendCommand("CALIBRATE_SYSTEM");
        }

        // config is a JSON object containing (at least) duration, temp, and power.
        // power is a percentage between 0 and 100 with 100 representing the max
        // power we allow the laser to be set at
        function startLaser(){ 
            if (DISPLAY_STATE.currentStep == "trial" && trialConfig.temperature > 0) {
                sendCommand("START_LASER");
                if (STATUS.isArmed) { displayLaserActiveWarning(); }
                STATUS.laserIsSetToOn = true;
            }
        }
        function stopLaser(){
            if (STATUS.laserIsSetToOn) {
                BACKEND_CONFIG["laser.option_enable"] = STATUS.laserIsSetToOn; 
                sendCommand("STOP_LASER");
                if (STATUS.isConnected) {
                    clearPersistentAlerts();
                }
            }
            STATUS.laserIsSetToOn = false;
        }
        function sendHeartBeat(){
            sendCommand("BEAT");
        }
        

        // request API - http://ip_address:port/requests/GET_STATUS, http://ip_address:port/requests/GET_TARGET_INFO 

        function sendRequest(request) {
            // this line specs the command API - http://ip_address:port/commands/SOME_COMMAND
            var requestPromise = false;
            try {
                requestPromise = fetch('http://'+SYSTEM_SETTINGS.ip+':'+SYSTEM_SETTINGS.port+'/'+request, {method:"get", body:String(new Date().getTime())})
                .then(function(response) {
                    if (response.status == "200") {
                        // OK
                        console.log('Request ',request,' executed successfully.');
                    }
                    if (response.status == "202") {
                        // ACCEPTED
                        setStatusAreaText(request + " request received, pending...");
                        setStatusAreaColor('rgb(200,180,0)');
                    }
                    if (response.status == "408") {
                        // TIMEOUT
                        setStatusAreaText(request + " request timed out.");
                        setStatusAreaColor('red');
                    }
                    if (response.status == "500") {
                        // INTERNAL SERVER ERROR
                        setStatusAreaText("Server failure, failed to issue "+request+" request.");
                        setStatusAreaColor('red');
                    }
                    if (response.status == "503") {
                        // SERVICE UNAVAILABLE
                        setStatusAreaText("Service unavailable, failed to issue "+request+" request.");
                        setStatusAreaColor('red');
                    }
                    return response.json();
                }).catch( (err) => {
                        setStatusAreaText("Request "+request+" not sent because PC is disconnected.");
                        setStatusAreaColor("orange");
                });
            } catch (err) {
                console.log("Caught: ", err.message);
            }
        }

        function mockTargetInfo() {

            // Uncomment this (and play with values) to test functionality:
            let i = Math.floor(new Date().getTime() / 200) % 125;
            
            return {
                "2":{"box":[100,i*2,150,i*2 + 50], "center":[125,i*2 + 25], "timestamp":0}, 
                "3":{"box":[i*2.8,200,i*2.8+50,250], "center":[i*2.8+25,215], "timestamp":0}
            };

            // 

        }

        function updateDataFromInstrument () {
            let statusString = sendRequest('status');
            if (statusString) {
                let status = JSON.parse(statusString);
                let visible = status.visible[0];
                let thermal = status.thermal[0];
                let laser = status.laser[0];
                var newTracks = {};
                for (let i = 0; i < visible.results.length; i++) {
                    let trackId = visible.results[i].id;
                    let center = visible.results[i].center;
                    let ts = visible.t;
                    let box = visible.results[i].box;
                    newTracks[trackId] = {
                        box:[box[0],box[1],box[2],box[3]],
                        center:[center[0],center[1]],
                        timestamp:ts,
                    };
                }
                TRACKS = newTracks;
                TARGET_INFO.temp.hotspot = thermal.temp_high;
                TARGET_INFO.temp.atTemp = laser.d < dStabilityThreshold;

                STATUS.isArmed = laser.armed;
                STATUS.isAlive = laser.hbm;
                STATUS.remoteEnabled = laser.enrem;
                STATUS.timeLastResponded = Math.max(visible.t, thermal.t, laser.t);
                STATUS.diskSpace = 100;// = status.disk_space; // in number of minutes of recording left
                if(new Date().getTime() - STATUS.timeLastResponded > SYSTEM_SETTINGS.timeoutMilSec) {} else {
                    setIndicator(0, false);
                    STATUS.isConnected = false;
                    stopLaser();
                }
                return true;
            }
            return false;
        }

    </script>

</body>
</html>