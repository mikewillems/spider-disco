<!DOCTYPE html>
<html style="width:100vw; height:100vh;">
<head>
    <title>This place is *groovy*...</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="fav1.ico">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0">
    <style type="text/css">
        .scroll::-webkit-scrollbar {
            width: 1vh;
        }
        .scroll::-webkit-scrollbar-track {
            background: #ddd;
        }
        .scroll::-webkit-scrollbar-thumb {
            background: #777; 
        }
        .cam-select-button {
            font-family:'Roboto Mono', monospace;
            padding:1vh;
            font-size:90%;
            font-weight:bold;
            text-transform:capitalize;
            background-color:white;
        }
        .cam-select-button:focus {
            outline: 0;
        }
        .cam-select-button:active {
            border-top: 3px solid rgb(150,150,150);
            border-left: 2.5px solid rgb(150,150,150);
            border-bottom: 1px solid rgb(225,225,225);
            border-right: 1px solid rgb(225,225,225);
        }
        .pressed-cam-select-button {
            background-color: #f0f0f0;
            border-top: 2.5px solid rgb(170,170,170);
            border-left: 2.5px solid rgb(170,170,170);
            border-bottom: 2px solid rgb(225,225,225);
            border-right: 2px solid rgb(225,225,225);
        }
        .view {
            margin:0; 
            padding:0; 
            display:none;
        }
        a, a:visited {
            color:black;
            text-decoration:none;
        }
        li {
            margin-top:0.5em;
        }
        .disabled-datum {
            background-color:rgb(225,225,225);
            color:rgb(100,100,100);
        }
        .setup-datum {
            margin-top:.5em;
        }
        .setup-datum-title {
            font-weight: bold;
        }
        .setup-datum-value {
            font-size:120%;
            text-indent:1em;
            margin-top:0.25em;
            width:100%;
            border: 1px solid black;
        }
    </style>
</head>
<body style="display:flex; flex-direction:row; justify-content:center; align-items:center; width:100vw; height:100vh; margin:0; font-family:'Roboto Mono', monospace; font-size:2.65vh;">

    <div id="main-screen" style="display:flex; flex-direction:row; width:1280px; height:768px; max-width:100vw; max-height:100vh;">
        <div id="left-section" style="width:auto; display:inline-block;">

            <div id="alert-message-board" style="display:fixed; position:absolute; z-index:1000000; width:960px; max-width:75vw; background-color:rgba(0,0,0,.5);">
            </div>

            <div id="video-container" style="width:960px; max-width:75vw; height:691px; max-height:90vh; position:relative; display:flex; flex-direction:row; align-items:center;">
                <img id="visible-cam-output" src="visible_cam_output.png" alt="visible camera not connected" style="display:none;"/>
                <img id="thermal-cam-output" src="thermal_cam_output.png" alt="thermal camera not connected" style="display:none;">
                <div id="camera-select-bar" style="position:absolute; bottom:2px; left:2px; display:flex; justify-content:center; width:30%; height:auto;">
                    <button id="visual-button" class="tab-select cam-select-button" style="width:50%;">
                    visual
                    </button>
                    <button id="thermal-button" class="tab-select cam-select-button" style="width:50%;">
                    thermal
                    </button>
                </div>    
            </div>
            <div id="status-area-container" style="display:flex; width:100%; height:10vh">
                <div id="status-area" style="display:flex; justify-content:space-around; align-items:center; width:100%; height:10vh; padding-left:1em; padding-right:1em; background-color:black; color:white;">
                </div>
            </div>

            
        </div>
        <div id="right-section" style="width:100%; height:100%; overflow-y:hidden;">
            <div id="right-section-scroll-wrapper" class="scroll" style="width:100%; padding:0; height:580px; max-height:76vh; overflow-y:auto; margin-bottom:0.5em;">
                <div id="right-section-info-div" style="padding-left:1em; padding-right:1em; display:flex; flex-direction:column; justify-content: space-between;">
                    <h1 id="step-title" style="text-decoration:none; font-weight:bold; text-transform:uppercase; font-size:125%; padding-top:0.5em; text-align: center; border-bottom:2px solid black;"></h1>
                    <p id="instruction-text" style="margin-top:0;"></p>
                </div>
                <div id="right-section-views-div" style="padding-left:1em; padding-right:1em; display:flex; flex-direction:column; justify-content: space-between;">

                    <div id="completed-trials-view"  class="view" style="margin:0; padding:0; display:none; border: 1px solid rgb(170,170,170); background-color: rgb(225,225,225);">
                        <ul id="completed-trials-list" style="list-style-type:none; margin:0.5em; padding:0;">
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                            <li class="trial-list-entry">2019-07-08_17:04:36</li>
                        </ul>
                    </div>

                    <div id="trial-setup-view"  class="view">
                        <div class="setup-datum">
                            <div class="setup-datum-title">
                                Duration
                            </div>
                            <div class="setup-datum-value" id="setup">
                                manual (max)
                            </div>
                        </div>
                        <div class="setup-datum">
                            <div class="setup-datum-title">
                                Max Power
                            </div>
                            <div class="setup-datum-value" id="setup">
                                100.0
                            </div>
                        </div>
                        <div class="setup-datum">
                            <div class="setup-datum-title">
                                Target Set Temp Delta
                            </div>
                            <div class="setup-datum-value" id="setup">
                                12&#8451;
                            </div>
                        </div>
                        <div class="setup-datum">
                            <div class="setup-datum-title">
                                Ambient Setting
                            </div>
                            <div class="setup-datum-value disabled-datum" id="setup">
                                disabled
                            </div>
                        </div>
                    </div>

                    <div id="calibration-view"  class="view">
                    </div>

                    <div id="target-data-view"  class="view" style="margin:0; padding:0; display:none;">
                        <div id="target-U-info" style="display:flex; flex-direction:column; align-items:center; justify-content:space-around;">
                            <div style="display:flex; flex-direction:row; justify-content:space-evenly; align-items:center; width:90%; text-align:center; color:rgb(42,116,145); border:2px solid rgb(42,116,145); font-weight:bold; font-size:110%;"><span>Target U</span><span>&#128393;</span></div>
                            <table style="margin-bottom:0.75em;">
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(42,116,145);">Set: </span></span></td><td><span id="target-U-set-temp">--</span>&#8451;</td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(42,116,145);">Temp: </span></td><td><span id="target-U-current-temp">--</span>&#8451;</td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(42,116,145);">(x,y): </span></td><td><span id="target-U-x-pos">--</span>mm,<span id="target-U-y-pos">--</span>mm</td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(42,116,145);">Moved: </span></td><td><span id="target-U-distance-moved">--</span>mm</td></tr>
                            </table>
                        </div>
                        <div id="target-H-info" style="display:flex; flex-direction:column; align-items:center; justify-content:space-around;">
                            <div style="display:flex; flex-direction:row; justify-content:space-evenly; align-items:center; width:90%; text-align:center; color:rgb(104,0,52); border:2px solid rgb(104,0,52); font-weight:bold; font-size:110%;"><span>Target H</span><span>&#128393;</span></div>
                            <table style="margin-bottom:0.75em;">
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(104,0,52);">Set: </span></span></td><td><span id="target-H-set-temp">--</span>&#8451;</td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(104,0,52);">Temp: </span></td><td><span id="target-H-current-temp">--</span>&#8451;</td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(104,0,52);">(x,y): </span></td><td><span id="target-H-x-pos">--</span>mm,<span id="target-H-y-pos">--</span>mm</td></tr>
                                <tr><td style="text-align:right;"><span style="font-weight:bold; color:rgb(104,0,52);">Moved: </span></td><td><span id="target-H-distance-moved">--</span>mm</td></tr>
                            </table>
                        </div>
                    </div>    
                </div>
                
            </div>
            <div id="right-section-static-div" style="margin-left:0.75em; margin-right:0.75em; display:flex; flex-direction:column; justify-content:space-between;">
                <div id="indicators-div" style="display:flex; flex-direction:column; align-items:flex-start; margin-left: 0.75em; font-size:90%; height:88px; max-height:12vh;">
                    <div id="pc-connection-indicator" class="indicator-light" style="display:flex; flex-direction:row;"><div style="width:0.75em; height:0.75em; border:2px solid black; margin:2px; margin-right:.75em"></div><div>PC Connected</div></div>
                    <div id="enrem-indicator" class="indicator-light" style="display:flex; flex-direction:row;"><div style="width:0.75em; height:0.75em; border:2px solid black; margin:2px; margin-right:.75em"></div><div>Remote Enabled</div></div>
                    <div id="calibrated-indicator" class="indicator-light" style="display:flex; flex-direction:row;"><div style="width:0.75em; height:0.75em; border:2px solid black; margin:2px; margin-right:.75em"></div><div>System Calibrated</div></div>
                </div>
                <div id="action-button-container" style="width:90%; height:76px; max-height:10vh; display:flex; flex-direction:row; justify-content:space-around; align-items:flex-end;">
                    <button disabled id="secondary-action-button" style="font-weight:bold; font-size: 2.5vh; width:60px; max-width:7vh; height:90%; font-family:'Roboto Mono', monospace;"><span id="secondary-action-button-span"><</span></button>
                    <button disabled id="primary-action-button" style="font-weight:bold; font-size: 2.5vh; display:flex; flex-direction:row; justify-content:center; align-items:center; width:225px; max-width:25vh; height:90%; font-family:'Roboto Mono', monospace;"><span id="primary-action-button-span" style="font-weight:bold;">START TRIAL</span><span id="right-arrow-span" style="font-weight:bold;">&nbsp;></span></button>
                </div>
            </div>
        </div>
    </div>

    <div id="load-popup" class="popup">
        
    </div>

    <div id="save-popup" class="popup">
        
    </div>

    <script type="text/javascript">

// FRONT-END FUNCTIONS

        // Button 0 = Visual, Button 1 = Thermal
        var cameraViewState = [false, false];
        function updateCameraView(){
            let showVisible = cameraViewState[0];
            let showThermal = cameraViewState[1];
            let visibleCamElement = document.getElementById('visible-cam-output');
            let thermalCamElement = document.getElementById('thermal-cam-output');
            let numActiveCamsViews = +showVisible + +showThermal;
            if(numActiveCamsViews == 1) {
                visibleCamElement.style.width = "100%";
                visibleCamElement.style.height = "100%";
                thermalCamElement.style.width = "100%";
                thermalCamElement.style.height = "100%";
            }
            if(numActiveCamsViews == 2) {
                visibleCamElement.style.width = "50%";
                visibleCamElement.style.height = "50%";
                thermalCamElement.style.width = "50%";
                thermalCamElement.style.height = "50%";
            }
            
            if(showVisible) {visibleCamElement.style.display = "flex";}
            else{visibleCamElement.style.display = "none";}

            if(showThermal) {thermalCamElement.style.display = "flex";} 
            else{thermalCamElement.style.display = "none";}
        }
        function updateCameraButtonView(){
            var camViewSelectButtons = document.getElementsByClassName('cam-select-button');
            var camViewSelectButton;
            for (var cameraViewStateIndex in cameraViewState){
                camViewSelectButton = camViewSelectButtons[cameraViewStateIndex];
                if(cameraViewState[cameraViewStateIndex]){
                    camViewSelectButton.classList.add('pressed-cam-select-button');
                } else {
                    camViewSelectButton.classList.remove('pressed-cam-select-button');
                }
            }

        }
        function pushCameraViewButton(index){            
            // If at least one camera is selected after toggling the view that was pressed, toggles that camera's visibility and update buttons:
            if(+!cameraViewState[index] + +cameraViewState[+!index]){
                cameraViewState[index] = !cameraViewState[index];
                updateCameraView();
                updateCameraButtonView();
            }
            // Otherwise, pressing the button again does nothing.
        }
        function clearPersistentAlerts() {
            alerts = document.getElementById('alert-message-board');
            while (alerts.firstChild) {
               alerts.removeChild(alerts.firstChild);
            }
        }
        function displayPersistentAlert(message, color) {
            clearPersistentAlerts();
            var messageDiv = document.createElement('div');
            messageDiv.appendChild(document.createTextNode(message));
            messageDiv.style = "position:absolute; top: 5vh; color:"+color+"; font-weight:bold; text-transform:capitalize; margin-left: 1em; font-size:5vh; background-color:rgba(0,0,0,0.5); padding-left:0.5em; padding-right:0.5em;";
            messageDiv.setAttribute("id", "alert"+document.getElementsByClassName('persistent-alert').length);
            messageDiv.setAttribute("class", "persistent-alert");
            messageDiv.appendChild(document.createElement('br'));
            document.getElementById('alert-message-board').appendChild(messageDiv);

        }
        function displayLaserArmedWarning(){
            displayPersistentAlert('WARNING: laser armed!', 'yellow');
        }
        function displayLaserActiveWarning(){
            displayPersistentAlert('DANGER: laser active!', 'red');
        }
        function clearStatusArea(){
            statusArea = document.getElementById('status-area');
            while (statusArea.firstChild) {
               statusArea.removeChild(statusArea.firstChild);
            }
        }
        function getSpan(id, contentNode) {
            var newSpan = document.createElement('span');
            newSpan.setAttribute('id', id);
            newSpan.appendChild(contentNode);
            return newSpan;
        }
        function getTimeStamp(seconds) {
            return "" + Math.floor(seconds / 60) + ":" + ("0" + seconds % 60).slice(-2); 
        }
        function showTrialProgress(secElapsed, secTotal){
            clearStatusArea();

            var statusMessage = document.createTextNode("Disco in progress... ");

            var progressBar = document.createElement('progress');
            progressBar.setAttribute('id', 'progress-bar');
            progressBar.setAttribute('value', secElapsed);
            progressBar.setAttribute('max', secTotal);

            var elapsedTimeDisplay = document.createTextNode(getTimeStamp(secElapsed));
            var statusSpacer = document.createTextNode(" / ");
            var trialLengthDisplay = document.createTextNode(getTimeStamp(secTotal));

            statusArea.appendChild(getSpan('progress-bar-span', statusMessage));
            statusArea.appendChild(getSpan('progress-bar-span', progressBar));
            statusArea.appendChild(getSpan('elapsed-time-display', elapsedTimeDisplay));
            statusArea.appendChild(getSpan('elapsed-time-display', statusSpacer));
            statusArea.appendChild(getSpan('elapsed-time-display', trialLengthDisplay));
        }
        // Pass in a dict to update data display for a particular target.
        // If useLonghand is true, use the DOM IDs for keys, else use the JS shorthand:
        function updateTargetDataDisplay(dataObj, useLonghand){
            var dataIDs = {
                "setF"  :"target-U-set-temp",
                "tempF" :"target-U-current-temp",
                "xF"    :"target-U-x-pos",
                "yF"    :"target-U-y-pos",
                "movedF":"target-U-distance-moved",
                "setM"  :"target-H-set-temp",
                "tempM" :"target-H-current-temp",
                "xM"    :"target-H-x-pos",
                "yM"    :"target-H-y-pos",
                "movedM":"target-H-distance-moved",
            };
            for (var key in dataObj){
                let targetId = useLonghand ? key : dataIDs[key];
                let val = dataObj[key];
                if(val) document.getElementById(targetId).innerHTML = val;
            };
        }
        function setStatusAreaColor(color){
            document.getElementById('status-area').style.backgroundColor=color;
        }
        // isOn = true for green, isOn = false for red
        function setIndicator(index, isOn){ 
            var indicator=document.getElementsByClassName('indicator-light')[index].firstChild.style.backgroundColor = isOn ? "green" : "red";
        }
        // clears specified indicator by setting background to transparent
        function clearIndicator(index) {
            var indicator=document.getElementsByClassName('indicator-light')[index].firstChild.style.backgroundColor = "transparent";
        }
        function enablePrimaryActionButton(enable){
            if(enable) {
                document.getElementById("primary-action-button").removeAttribute("disabled");
            } else {
                document.getElementById("primary-action-button").setAttribute("disabled", "disabled");
            }
        }
        function setPrimaryActionButtonText(text){
            document.getElementById('primary-action-button-span').innerHTML = text;
        }
        function enableBackButton(enable){
            if(enable) {
                document.getElementById("secondary-action-button").removeAttribute("disabled");
            } else {
                document.getElementById("secondary-action-button").setAttribute("disabled", "disabled");
            }
        }
        function setStepTitleText(newTitle){
            document.getElementById('step-title').innerHTML = newTitle;
        }
        function setInstructionText(newInstructions){
            document.getElementById('instruction-text').innerHTML = newInstructions;
        }
        function setView(prevViewId, newViewId){
            document.getElementById(prevViewId).style.display = 'none';            
            document.getElementById(newViewId).style.display = 'block';
        }
        function setContent(){

        }
        function setStep(stepKey) {
            if(stepKey){
                var prevStepObj = discoSteps[currentStep];
                currentStep = stepKey;
                var currentStepObj = discoSteps[stepKey];
                setStepTitleText(currentStepObj.title);
                setView(prevStepObj.view, currentStepObj.view);
                setInstructionText(currentStepObj.instructions);
                setContent(currentStepObj.content);
                setPrimaryActionButtonText(currentStepObj.actionButtonText);
                enableBackButton(currentStepObj.previousStep);
                if(stepKey == 'trial') {
                    document.getElementById('right-arrow-span').innerHTML = '';
                } else {
                    document.getElementById('right-arrow-span').innerHTML = '&nbsp;>';
                }
                currentStepObj.initialize();
            }
        }
        function pushBackButton(){
            setStep(discoSteps[currentStep].previousStep);
        }
        function pushActionButton(){;
            setStep(discoSteps[currentStep].nextStep);
        }
        function initHomeStep(){

        }
        function initSetupStep(){
 
        }
        function initCalibrationStep(){

        }
        function initPlacementStep(){

        }
        function initSafetyStep(){

        }
        function initTrialStep(){

        }
        var currentStep = 'home';        

        var discoSteps = {
            'home':{
                'title':'Welcome to the Disco!',
                'instructions':'Select a prior trial from the list below to review and send, or start a new trial by choosing Trial Setup.',
                'view':'completed-trials-view',
                'content':'',
                'actionButtonText':'Trial Setup',
                'initialize':initHomeStep,
                'previousStep':false,
                'nextStep':'setup',
            },
            'setup':{
                'title':'Trial Setup',
                'instructions':'Select trial parameters.',
                'view':'trial-setup-view',
                'content':'',
                'actionButtonText':'Calibration',
                'initialize':initSetupStep,
                'previousStep':'home',
                'nextStep':'calibration',
            },
            'calibration':{
                'title':'Calibration',
                'instructions':'Place the calibration tool in the center of the arena, then position the disco machine so that the entire arena floor is unobscured in the mask to the left.',
                'view':'calibration-view',
                'content':'',
                'actionButtonText':'Specimen Loading',
                'initialize':initCalibrationStep,
                'previousStep':'setup',
                'nextStep':'placement',
            },
            'placement':{
                'title':'Specimen Loading',
                'instructions':'',
                'content':'',
                'view':'target-data-view',
                'actionButtonText':'Safety Checks',
                'initialize':initPlacementStep,
                'previousStep':'calibration',
                'nextStep':'safety',
                // Individual sub-steps: Remove the calibration tool and place the specimen to be heated in the arena. Now place the unheated specimen in the arena.
            },
            'safety':{
                'title':'Safety Checks',
                'instructions':'This instrument uses a 300mW 808nm near-IR laser which is capable of causing permanent damage to they eye.',
                'view':'target-data-view',
                'content':'',
                'actionButtonText':'START TRIAL',
                'initialize':initSafetyStep,
                'previousStep':'placement',
                'nextStep':'trial',
                // Checklist:
                // All operators are using protective eyewear.
                // The safety hood is in place.
                // The experiment room is clearly marked on the outside to warn against entry by additional parties.
            },
            'trial':{
                'title':'Trial in Progress',
                'instructions':'Press "STOP TRIAL" at any time to end the current trial and turn off the laser.',
                'view':'target-data-view',
                'content':'',
                'actionButtonText':'STOP TRIAL',
                'initialize':initTrialStep,
                'previousStep':false,
                'nextStep':'home',
            },
        }

        function initializeAppUI(){
            // Button 0 = Visual, Button 1 = Thermal
            cameraViewState = [false, false];
            pushCameraViewButton(0);
            pushCameraViewButton(1);
            setStep('home');
            enablePrimaryActionButton(true);

            document.getElementById('visual-button').addEventListener('click', ()=>{pushCameraViewButton(0);}, true);
            document.getElementById('thermal-button').addEventListener('click', ()=>{pushCameraViewButton(1);}, true);
            document.getElementById('primary-action-button').addEventListener('click', pushActionButton, true);
            document.getElementById('secondary-action-button').addEventListener('click', pushBackButton, true);

        }
        initializeAppUI();



        function testVisuals(turnOn){
            if(turnOn) {
                displayLaserArmedWarning();
                showTrialProgress(68, 180);
                setIndicator(0,false);
                setIndicator(1,true);
            } else {
                clearPersistentAlerts();
                clearStatusArea();
                clearIndicator(0);
                clearIndicator(1);
            }
        }

// SYNCHRONIZATION

        function refreshCameraImages(){
            let randNum = Math.floor(Math.random()*Math.pow(10,10));
            document.getElementById('visible-cam-output').src = 'visible_cam_output.png?'+randNum;
            document.getElementById('thermal-cam-output').src = 'thermal_cam_output.png?'+randNum;
        }
        setInterval(refreshCameraImages, 500);

// HARDWARE INTERFACE FUNCTIONS
    
        function laserIsArmed() {
            // Implement with feedback from DISARM signal
        }

//********************************************************************
// BACKEND INTERFACE FUNCTIONS ********* IMPLEMENT THIS!!!************
        


        

    </script>

</body>
</html>